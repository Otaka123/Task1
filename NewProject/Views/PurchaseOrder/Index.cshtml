@using Domain.DTOS.Filters
@using Domain.DTOS.Purchase
@{
    Layout = "~/Views/Shared/_MainLayout.cshtml";
}

@model PagedResultN<PurchaseOrderDto>

<div class="col-md-6 d-flex align-items-center justify-content-start gap-1 flex-wrap">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0 py-2">
            <li class="breadcrumb-item">

            </li>
            <li class="breadcrumb-item"><a asp-controller="PurchaseOrder" asp-action="Index">وحدة أوامر الشراء </a></li>
            <li>
                <a href="#" active> قائمة أوامر الشراء</a>
            </li>
        </ol>
    </nav>
</div>   


    <!-- زر الإضافة -->
<div class="mb-3 d-flex justify-content-end">
    <a href="@Url.Action("Create")" class="btn btn-rss">اضافة امر شراء</a>
</div>

<!-- فورم البحث والتصفية -->
<form method="get" class="card mb-4" id="searchForm">
    <div class="card-body">
        <div class="row g-3 align-items-end ">
            
            <!-- اسم المورد -->
            <div class="col-md-3 mb-4">
                <select name="supplierId" class="form-select" asp-items="ViewBag.Suppliers">
                    <option value="">اختر المورد</option>
                </select>
                <div id="spacee" style="min-height: 1.5em; display:none;"></div>

            </div>

            <!-- من تاريخ -->
            <div class="col-md-2 mb-4">
                <label for="fromDate" class="form-label">من</label>
                <input type="date" id="fromDate" name="fromDate" class="form-control" value="@ViewBag.FromDate" />
                <span id="fromDateError" class="text-danger " style="display:none;">تاريخ البداية يجب أن يكون قبل تاريخ النهاية</span>
            </div>

            <!-- إلى تاريخ -->
            <div class="col-md-2 mb-4">
                <label for="toDate" class="form-label">إلى</label>
                <input type="date" id="toDate" name="toDate" class="form-control" value="@ViewBag.ToDate" />
                <span id="toDateError" class="text-danger  " style="display:none;">تاريخ النهاية يجب أن يكون بعد تاريخ البداية</span>
            </div>


            <div class="col-md-5 d-flex justify-content-center align-items-center gap-1 mb-4">
                <button type="submit" onclick="return validateDates()" class="btn btn-rss btn-equal">بحث</button>
                <button type="button" class="btn btn-success btn-equal" onclick="printAllPurchaseOrders()">
                    <i class="fas fa-file-pdf"></i> طباعة
                </button>
                <div id="spacee" style="min-height: 1.5em; display:none;"></div>

            </div>

               
        </div>
    </div>
</form>


    <!-- جدول البيانات -->
    <div class="card">
        <div class="card-body">
            @if (Model.Items.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>رقم أمر الشراء</th>
                                <th>اسم المورد</th>
                                <th>التاريخ</th>
                                <th class="text-center">أدوات التحكم</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int counter = (Model.PageNumber - 1) * Model.PageSize + 1;
                            }
                            @foreach (var order in Model.Items)
                            {
                                <tr>
                                    <td>
                                        <strong>@order.PurchaseNumber</strong>
                                    </td>
                                    <td>@order.SupplierName</td>
                                    <td>@order.PurchaseDate.ToString("yyyy-MM-dd")</td>
                                    <td>
                                        <div class="d-flex align-items-center justify-content-center gap-2">
                                            <a href="@Url.Action("Details", new { id = order.Id })"
                                               class="btn btn-info btn-sm" title="التفاصيل">
                                                <i class="fas fa-eye"></i> 
                                            </a>
                                            <a href="@Url.Action("Edit", new { id = order.Id })"
                                               class="btn btn-warning btn-sm" title="تعديل">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-danger btn-sm delete-btn"
                                                data-purchase-number="@order.PurchaseNumber"
                                                data-id="@order.Id" title="حذف">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                counter++;
                            }
                        </tbody>
                    </table>
                </div>

                <!-- التصفح -->
                @if (Model.TotalCount > Model.PageSize)
                {
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            @{
                                int totalPages = (int)Math.Ceiling((double)Model.TotalCount / Model.PageSize);
                                int startPage = Math.Max(1, Model.PageNumber - 2);
                                int endPage = Math.Min(totalPages, Model.PageNumber + 2);
                            }

                            <!-- زر السابق -->
                            <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                                <a class="page-link"
                                   href="@Url.Action("Index", new { pageNumber = Model.PageNumber - 1, pageSize = Model.PageSize, supplierId = ViewBag.SupplierId, fromDate = ViewBag.FromDate, toDate = ViewBag.ToDate, purchaseNumber = ViewBag.PurchaseNumber })">
                                    السابق
                                </a>
                            </li>

                            <!-- أرقام الصفحات -->
                            @for (int i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                    <a class="page-link"
                                       href="@Url.Action("Index", new { pageNumber = i, pageSize = Model.PageSize, supplierId = ViewBag.SupplierId, fromDate = ViewBag.FromDate, toDate = ViewBag.ToDate, purchaseNumber = ViewBag.PurchaseNumber })">
                                        @i
                                    </a>
                                </li>
                            }

                            <!-- زر التالي -->
                            <li class="page-item @(Model.PageNumber == totalPages ? "disabled" : "")">
                                <a class="page-link"
                                   href="@Url.Action("Index", new { pageNumber = Model.PageNumber + 1, pageSize = Model.PageSize, supplierId = ViewBag.SupplierId, fromDate = ViewBag.FromDate, toDate = ViewBag.ToDate, purchaseNumber = ViewBag.PurchaseNumber })">
                                    التالي
                                </a>
                            </li>
                        </ul>
                    </nav>
                }

                <!-- إحصائيات -->
                <div class="mt-3 text-muted">
                    <small>
                        عرض @((Model.PageNumber - 1) * Model.PageSize + 1) إلى @Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount)
                        من أصل @Model.TotalCount طلب شراء
                    </small>
                </div>
            }
            else
            {
                <div class="alert alert-info text-center text-black">
                    <i class="fas fa-info-circle"></i> لا توجد أوامر شراء
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal for delete confirmation -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">تأكيد الحذف</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                هل أنت متأكد من أنك تريد حذف هذا العنصر؟
                <div id="itemDetails" class="mt-2 text-muted small"></div>
            </div>
            <div class="modal-footer text-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">نعم حذف</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/4.0.0/jquery.validate.unobtrusive.min.js"></script>
    <script>
                // 🔹 دالة طباعة العرض الحالي
        function printCurrentView() {
            var now = new Date();
            var fileName = "أوامر_الشراء_" +
                now.getFullYear() +
                ('0' + (now.getMonth() + 1)).slice(-2) +
                ('0' + now.getDate()).slice(-2) + "_" +
                ('0' + now.getHours()).slice(-2) +
                ('0' + now.getMinutes()).slice(-2) +
                ('0' + now.getSeconds()).slice(-2) +
                ('00' + now.getMilliseconds()).slice(-3) +
                "_" + Math.floor(Math.random() * 1000);

            // حفظ العنوان الأصلي
            var originalTitle = document.title;

            // تعيين الاسم الفريد
            document.title = fileName;
            window.print();

            // استعادة العنوان الأصلي بعد الطباعة
            setTimeout(function() {
                document.title = originalTitle;
            }, 1000);
        }

        // 🔹 دالة طباعة جميع السجلات
        function printAllPurchaseOrders() {
            // جمع معايير البحث الحالية
            const supplierId = document.getElementById('supplierId')?.value || '';
            const fromDate = document.getElementById('fromDate')?.value || '';
            const toDate = document.getElementById('toDate')?.value || '';

            // إظهار رسالة تحميل
            showLoadingMessage('جاري تحضير البيانات للطباعة...');

            // بناء URL للطباعة بجميع البيانات
            let url = '/PurchaseOrder/PrintPurchaseOrders?';
            const params = [];

            if (supplierId) params.push(`supplierId=${encodeURIComponent(supplierId)}`);
            if (fromDate) params.push(`fromDate=${encodeURIComponent(fromDate)}`);
            if (toDate) params.push(`toDate=${encodeURIComponent(toDate)}`);

            // إضافة pageSize كبير لجلب جميع البيانات (بحد أقصى 400)
            params.push(`pageSize=400`);
            params.push(`pageNumber=1`);

            url += params.join('&');

            // فتح نافذة جديدة للطباعة
            const printWindow = window.open(url, '_blank');

            // إخفاء رسالة التحميل بعد فتح النافذة
            setTimeout(() => {
                hideLoadingMessage();
            }, 2000);

            // إذا فشل فتح النافذة
            if (!printWindow) {
                hideLoadingMessage();
                showErrorMessage('تم منع النافذة المنبثقة. الرجاء السماح بالنوافذ المنبثقة لهذا الموقع.');
            }
        }

        // 🔹 دالة إظهار رسالة التحميل
        function showLoadingMessage(message) {
            // إزالة أي رسالة تحميل موجودة مسبقاً
            hideLoadingMessage();

            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 20px 30px;
                border-radius: 10px;
                z-index: 10000;
                font-size: 16px;
                text-align: center;
            `;
            loadingDiv.innerHTML = `
                <div class="spinner-border text-light mb-2" role="status">
                    <span class="visually-hidden">جاري التحميل...</span>
                </div>
                <div>${message}</div>
            `;

            document.body.appendChild(loadingDiv);
        }

        // 🔹 دالة إخفاء رسالة التحميل
        function hideLoadingMessage() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        // 🔹 دالة إظهار رسالة خطأ
        function showErrorMessage(message) {
            // إزالة أي رسالة خطأ موجودة مسبقاً
            const existingError = document.getElementById('error-message');
            if (existingError) {
                existingError.remove();
            }

            const errorDiv = document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f8d7da;
                color: #721c24;
                padding: 15px 20px;
                border: 1px solid #f5c6cb;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                max-width: 400px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            `;
            errorDiv.innerHTML = `
                <strong>خطأ:</strong> ${message}
                <button type="button" class="btn-close float-start" onclick="this.parentElement.remove()" style="margin-top: 2px;"></button>
            `;

            document.body.appendChild(errorDiv);

            // إزالة تلقائية بعد 5 ثواني
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }
        // متغير لحفظ معرف العنصر المراد حذفه
        let itemIdToDelete = null;

        // التحقق من صحة التواريخ
        function validateDates() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const fromDateError = document.getElementById('fromDateError');
            const toDateError = document.getElementById('toDateError');
            const sub= document.getElementById('spacee')
            // إخفاء رسائل الخطأ أولاً
            fromDateError.style.display = 'none';
            toDateError.style.display = 'none';
            document.getElementById('fromDate').classList.remove('is-invalid');
            document.getElementById('toDate').classList.remove('is-invalid');

            // إذا كان كلا الحقلين مملوءين
            if (fromDate && toDate) {
                const from = new Date(fromDate);
                const to = new Date(toDate);

                if (from > to) {
                    fromDateError.style.display = 'block';
                    toDateError.style.display = 'block';
                    sub.style.display='block';
                    document.getElementById('fromDate').classList.add('is-invalid');
                    document.getElementById('toDate').classList.add('is-invalid');

                    return false;
                }
            }

            return true;
        }

        // إضافة حدث submit للنموذج
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            if (!validateDates()) {
                e.preventDefault();
                return false;
            }
        });

        // إضافة أحداث تغيير للتواريخ للتحقق الفوري
        document.getElementById('fromDate').addEventListener('change', validateDates);
        document.getElementById('toDate').addEventListener('change', validateDates);

        // التحقق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            validateDates();

            // إضافة أحداث لأزرار الحذف
            document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                itemIdToDelete = this.getAttribute('data-id');

                // عرض تفاصيل العنصر
                const purchaseNumber = this.getAttribute('data-purchase-number');
                const itemDetailsElement = document.getElementById('itemDetails');
                if (itemDetailsElement && purchaseNumber) {
                    itemDetailsElement.textContent = `أمر الشراء رقم: ${purchaseNumber}`;
                }

                const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
                modal.show();
            });
        });

                  // حدث تأكيد الحذف
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (itemIdToDelete) {
                // إظهار رسالة تحميل
                showLoadingMessage('جاري حذف أمر الشراء...');

                // إغلاق Modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmationModal'));
                modal.hide();

                // استخدام Ajax لإرسال طلب POST
                $.ajax({
                    url: '@Url.Action("Delete", "PurchaseOrder")/' + itemIdToDelete,
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        hideLoadingMessage();
                        // إعادة تحميل الصفحة أو تحديث الجدول
                        window.location.reload();
                    },
                    error: function(xhr, status, error) {
                        hideLoadingMessage();
                        showErrorMessage('فشل في حذف أمر الشراء: ' + error);
                    }
                });
            }
        });

            // تحديث العنوان مع تفاصيل البحث
            const urlParams = new URLSearchParams(window.location.search);
            const purchaseNumber = urlParams.get('purchaseNumber');
            const supplierId = urlParams.get('supplierId');

            if (purchaseNumber || supplierId) {
                document.querySelector('h2').textContent += ' (نتائج البحث)';
            }
        });
    </script>
}