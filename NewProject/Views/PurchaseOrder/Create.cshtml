@using Domain.DTOS.Purchase
@model CreatePurchaseOrderDto

@{
    Layout = "~/Views/Shared/_MainLayout.cshtml";
    var savedItems = ViewBag.Items as List<PurchaseOrderItemDto> ?? new List<PurchaseOrderItemDto>();
}

<div id="page-container" class="page-container flex-grow-1">

    <!-- Breadcrumb Navigation Column -->
    <div class="card-header border-bottom d-flex align-items-start row my-3">
        <div class="d-flex align-items-center col-md-6 flex-wrap">
            <h4 class="ico-header-title">
                <i class="fa-solid fa-cart-shopping me-1 text-ico"></i>
                إضافة أمر الشراء
            </h4>
        </div>
        <div class="col-md-6 d-flex align-items-center justify-content-start gap-1 flex-wrap">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 py-2">
                    <li class="breadcrumb-item">
                    </li>
                    <li class="breadcrumb-item"><a asp-controller="PurchaseOrder" asp-action="Index">قائمة أوامر الشراء</a></li>
                    <li>
                        <a asp-controller="PurchaseOrder" asp-action="Create">إضافة أمر الشراء</a>
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="card p-3">
        <div class="container-fluid">
            <form asp-action="Create" method="post" id="forma">
                @Html.AntiForgeryToken()

                <div class="row">
                    <!-- Purchase Number (Auto-generated - Display Only) -->
                    <div class="col-md-10">
                        <label for="PurchaseNumberDisplay" class="form-label fw-semibold">رقم أمر الشراء</label>
                        <input id="PurchaseNumberDisplay" value="@Model.PurchaseNumber" disabled readonly class="form-control mb-2" />
                        <input type="hidden" asp-for="PurchaseNumber" />
                    </div>
                    <!-- VAT Checkbox -->
                    <div class="col-md-2">
                        <div class="d-flex align-items-center gap-3 ms-1 mt-3">
                            <input asp-for="HasVAT" class="form-check-input" style="transform: scale(1.6); cursor: pointer;" />
                            <label class="form-label fw-semibold d-block mt-3" for="HasVAT">With 5% VAT</label>
                        </div>
                        <span asp-validation-for="HasVAT" class="text-danger small"></span>
                    </div>

                    <!-- Date -->
                    <div class="col-md-6 mb-2">
                        <label asp-for="PurchaseDate" class="form-label fw-semibold">التاريخ</label>
                        <div class="input-icon-left">
                            <input asp-for="PurchaseDate" class="form-control green-border form-control-sm filter-bordered" type="date" />
                        </div>
                        <span asp-validation-for="PurchaseDate" class="text-danger small"></span>
                    </div>

                    <!-- Supplier -->
                    <div class="col-md-6">
                        <label asp-for="SupplierId" class="form-label fw-semibold">المورد</label>
                        <select asp-for="SupplierId" asp-items="ViewBag.Suppliers" class="form-control mb-2">
                            <option value="">-- اختر المورد --</option>
                        </select>
                        <span asp-validation-for="SupplierId" class="text-danger small"></span>
                    </div>
                </div>

                <!-- Items Addition Section -->
                <div class="row">
                    <div class="col-md-12 mt-3">
                        <div class="text-left sec-title">
                            <div class="lg-title">
                                <h4>إضافة بنود أمر الشراء</h4>
                            </div>
                            <div class="title-sep-left"></div>
                            <div class="title-sep-sm-left"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3">
                        <label for="Quantity" class="form-label fw-semibold">الكمية</label>
                        <input id="Quantity" class="form-control only-integer mb-2" type="text" value="1" min="1">
                        <span id="QuantitySpan" class="text-danger small"></span>
                    </div>
                    <div class="col-md-3">
                        <label for="SinglePrice" class="form-label fw-semibold">سعر الوحدة</label>
                        <input id="SinglePrice" placeholder="0.00" class="form-control mb-2" type="number" step="0.01" min="0">
                        <span id="SinglePriceSpan" class="text-danger small"></span>
                    </div>
                    <div class="col-md-4">
                        <label for="ItemName" class="form-label fw-semibold">البيان</label>
                        <input id="ItemName" class="form-control mb-2" type="text">
                        <span id="ItemNameSpan" class="text-danger small"></span>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-rss px-4 w-100" onclick="addRow()">
                            <i class="fa-solid fa-cart-plus me-2"></i> اضافة
                        </button>
                    </div>
                </div>

                <!-- Items List Section -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="text-left sec-title">
                            <div class="lg-title">
                                <h4>بنود أمر الشراء</h4>
                            </div>
                            <div class="title-sep-left"></div>
                            <div class="title-sep-sm-left"></div>
                        </div>
                    </div>
                </div>

                <!-- Items Table -->
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle table-striped">
                        <thead class="table-light">
                            <tr>
                                <th width="15%">الكمية</th>
                                <th width="20%">سعر الوحدة</th>
                                <th width="45%">البيان</th>
                                <th width="10%">أدوات التحكم</th>
                            </tr>
                        </thead>
                        <tbody id="Items">
                            <!-- Items will be added here dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Hidden fields for items -->
                <div id="hidden-items-container" style="display: none;">
                    <!-- Hidden inputs will be added here by JavaScript -->
                </div>

                <!-- Actions -->
                <div class="d-flex justify-content-end mt-3">
                    <button type="submit" class="btn btn-rss me-2">
                        <i class="fa-solid fa-floppy-disk me-1"></i>حفظ
                    </button>
                    <a class="btn btn-secondary" href="/Admin/PurchaseOrder">
                        رجوع<i class="fa-solid fa-arrow-left me-1"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal for delete confirmation -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">تأكيد الحذف</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                هل أنت متأكد من أنك تريد حذف هذا البند؟
            </div>
            <div class="modal-footer text-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">حذف</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/4.0.0/jquery.validate.unobtrusive.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        let itemIndex = 0;
        let rowToDelete = null;

        // تحميل البنود المحفوظة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedItems();
        });

        // دالة لتحميل البنود المحفوظة
        function loadSavedItems() {
            @if (savedItems.Any())
            {
                    foreach (var item in savedItems)
                    {
                            <text>
                            addSavedRow(@item.Quantity, @item.Price, '@Html.Raw(item.Description)');
                            </text>
                    }
            }
        }

        // دالة لإضافة صف محفوظ
        function addSavedRow(quantity, price, description) {
            const tableBody = document.getElementById('Items');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-index', itemIndex);
            newRow.innerHTML = `
                <td>${quantity}</td>
                <td>${parseFloat(price).toFixed(2)}</td>
                <td>${description}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="confirmRemoveRow(this)">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(newRow);

            // Add hidden inputs
            const hiddenContainer = document.getElementById('hidden-items-container');
            hiddenContainer.innerHTML += `
                <input type="hidden" name="Items[${itemIndex}].Quantity" value="${quantity}" />
                <input type="hidden" name="Items[${itemIndex}].Price" value="${price}" />
                <input type="hidden" name="Items[${itemIndex}].Description" value="${description}" />
            `;

            itemIndex++;
        }

        // إزالة الأصفار من اليسار في حقل الكمية
        document.getElementById('Quantity').addEventListener('input', function(e) {
            let value = e.target.value;

            // إزالة أي أحرف غير رقمية
            value = value.replace(/[^0-9]/g, '');

            // إزالة الأصفار من اليسار
            if (value.length > 1) {
                value = value.replace(/^0+/, '');
            }

            // إذا كانت القيمة فارغة بعد الإزالة، ضع 1 كقيمة افتراضية
            if (value === '' || parseInt(value) < 1) {
                value = '1';
            }

            e.target.value = value;
        });

        function addRow() {
            let quantity = document.getElementById('Quantity').value;
            const singlePrice = document.getElementById('SinglePrice').value;
            const itemName = document.getElementById('ItemName').value;

            // التأكد من أن الكمية لا تحتوي على أصفار في البداية
            quantity = quantity.replace(/^0+/, '');
            if (quantity === '') quantity = '1';

            // Validation
            if (!quantity || quantity <= 0) {
                document.getElementById('QuantitySpan').textContent = 'هذا الحقل مطلوب !';
                return;
            }
            if (!singlePrice || singlePrice <= 0) {
                document.getElementById('SinglePriceSpan').textContent = 'هذا الحق مطلوب !';
                return;
            }
            if (!itemName.trim()) {
                document.getElementById('ItemNameSpan').textContent = 'هذا الحقل مطلوب !';
                return;
            }

            // Clear validation messages
            document.getElementById('QuantitySpan').textContent = '';
            document.getElementById('SinglePriceSpan').textContent = '';
            document.getElementById('ItemNameSpan').textContent = '';

            // Add to table
            const tableBody = document.getElementById('Items');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-index', itemIndex);
            newRow.innerHTML = `
                <td>${quantity}</td>
                <td>${parseFloat(singlePrice).toFixed(2)}</td>
                <td>${itemName}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="confirmRemoveRow(this)">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(newRow);

            // Add hidden inputs
            const hiddenContainer = document.getElementById('hidden-items-container');
            hiddenContainer.innerHTML += `
                <input type="hidden" name="Items[${itemIndex}].Quantity" value="${quantity}" />
                <input type="hidden" name="Items[${itemIndex}].Price" value="${singlePrice}" />
                <input type="hidden" name="Items[${itemIndex}].Description" value="${itemName}" />
            `;

            itemIndex++;

            // Clear inputs
            document.getElementById('Quantity').value = '1';
            document.getElementById('SinglePrice').value = '';
            document.getElementById('ItemName').value = '';
        }

        // تأكيد الحذف - استخدام jQuery للتبسيط
        function confirmRemoveRow(button) {
            rowToDelete = button.closest('tr');
            $('#deleteConfirmationModal').modal('show');
        }

        // تنفيذ الحذف بعد التأكيد
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (rowToDelete) {
                // إزالة الصف من الجدول
                rowToDelete.remove();

                // إعادة فهرسة العناصر المخفية
                reindexHiddenInputs();

                // إغلاق المودال باستخدام jQuery
                $('#deleteConfirmationModal').modal('hide');

                rowToDelete = null;
            }
        });

        // إعادة فهرسة العناصر المخفية بعد الحذف
        function reindexHiddenInputs() {
            const hiddenContainer = document.getElementById('hidden-items-container');
            const tableBody = document.getElementById('Items');
            const rows = tableBody.getElementsByTagName('tr');

            // مسح الحاوية المخفية
            hiddenContainer.innerHTML = '';

            // إعادة إنشاء العناصر المخفية مع الفهرس الجديد
            itemIndex = 0;
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                if (cells.length >= 4) {
                    const quantity = cells[0].textContent;
                    const price = cells[1].textContent;
                    const description = cells[2].textContent;

                    hiddenContainer.innerHTML += `
                        <input type="hidden" name="Items[${itemIndex}].Quantity" value="${quantity}" />
                        <input type="hidden" name="Items[${itemIndex}].Price" value="${price}" />
                        <input type="hidden" name="Items[${itemIndex}].Description" value="${description}" />
                    `;

                    rows[i].setAttribute('data-index', itemIndex);
                    itemIndex++;
                }
            }
        }


   

                document.querySelector("#forma").addEventListener("submit", function (e) {
            const itemsCount = document.getElementById("Items").children.length;

            if (itemsCount === 0) {
                e.preventDefault();
                alert("يجب إضافة على الأقل بند واحد");
                return false;
            }
        });
        // Form submission validation
        // document.querySelector('form').addEventListener('submit', function(e) {
        //     const tableBody = document.getElementById('Items');
        //     if (tableBody.children.length === 0) {
        //         e.preventDefault();
        //         alert('يجب إضافة على الأقل بند واحد');
        //         return false;
        //     }
        // });
    </script>
}